?rake
lubrary(survey)
library(survey)
?rake
rm(list=ls())
library(foreign);library(survey); library(faraway)
dd<-read.dta("/Users/michelletorres/Dropbox/WEIGHTS_PROJECT/MichelleMargolis/dd_update.dta")
#Dataset-- M. Margolis
data.immig<-read.dta("/Users/michelletorres/Dropbox/WEIGHTS_PROJECT/MichelleMargolis/Imm_vars_clean.dta")
#Merged data
newdata<-merge(dd, data.immig, by="wustlid", all=TRUE)
colnames(newdata)[7]<-"ppnet"
rm(data.immig)
#Variables of interest and index
# Vars: IMMIG3S14, IMMIG3S22, IMMIG3S26, IMMIG6S14, IMMIG6S22, IMMIG6S26, IMMIG16S14, IMMIG16S22, IMMIG16S26
# Index: 22 27 30 23 28 31 24 29 32
outcome.vars<-c("IMMIG3S14", "IMMIG3S22", "IMMIG3S26", "IMMIG6S14", "IMMIG6S22", "IMMIG6S26", "IMMIG16S14", "IMMIG16S22", "IMMIG16S26")
index.vars<-unlist(apply(data.frame(outcome.vars), 1, FUN=function(x) which(colnames(newdata)==x)))
#########################
### REFUSED RECODING  ###
#########################
temp.data<-newdata[,index.vars]
temp.data[temp.data=="Refused"]<-NA
newdata[,index.vars]<-temp.data
rm(temp.data)
#Subset the data based on IMMIG3S14, IMMIG3S22, IMMIG3S26, IMMIG6S14, IMMIG6S22, IMMIG6S26, IMMIG16S14, IMMIG16S22, IMMIG16S26
newdata_complete<-newdata[complete.cases(newdata[,outcome.vars]),]
# Tabulations of variables
apply(newdata_complete[,outcome.vars],2,FUN=function(x) table(x))
# Temporal: delete all missing in demographics (177)
newdata_complete<-newdata_complete[!is.na(newdata_complete$agegend),]
#################################################################################################
# WEIGHTING
#################################################################################################
# IMPORTANT: Export and run population margins list
# Pop margins
pop.marg<-pop.margins
pop.margins <-
list(list(structure(list(agegend = structure(1:8, .Label = c("F18",
"F30", "F45", "F60", "M18", "M30", "M45", "M60"), class = "factor"),
Freq = c(25015824.2179, 30309875.9965, 32573327.9027, 31644763.1043,
25763098.0698, 29575256.9933, 30957724.9853, 26177261.0073
)), .Names = c("agegend", "Freq"), row.names = c(NA, -8L), class = "data.frame"),
structure(list(ethm = structure(c(5L, 2L, 4L, 3L, 1L), .Label = c("2+ Races, Non-Hispanic",
"Black, Non-Hispanic", "Hispanic", "Other, Non-Hispanic",
"White, Non-Hispanic"), class = "factor"), Freq = c(156450435.931,
26805108.3256, 12922130.6191, 33201634.7689, 2637822.6325
)), .Names = c("ethm", "Freq"), row.names = c(NA, -5L), class = "data.frame"),
structure(list(educat = structure(c(3L, 2L, 4L, 1L), .Label = c("Bachelor's Degree or More",
"High School", "Less than High School", "Some College"), class = "factor"),
Freq = c(30067821.4337, 70334087.0449, 66585593.7032,
65029630.0953)), .Names = c("educat", "Freq"), row.names = c(NA,
-4L), class = "data.frame"), structure(list(regmetro = structure(1:8, .Label = c("MWM",
"MWNM", "NEM", "NENM", "SM", "SNM", "WM", "WNM"), class = "factor"),
Freq = c(38779079.986, 11580740.4967, 38140143.6799,
4506384.8787, 69468312.5372, 15238273.1548, 48594531.843,
4142589.8707)), .Names = c("regmetro", "Freq"), row.names = c(NA,
-8L), class = "data.frame"), structure(list(incomcat = structure(c(1L,
2L, 4L, 5L, 6L, 3L), .Label = c("-10", "10-29", "100+", "30-49",
"50-79", "80-99"), class = "factor"), Freq = c(12591172.74,
43653282.56, 42016636.15, 50511057.84, 23758243.15, 58663387.09
)), .Names = c("incomcat", "Freq"), row.names = c(NA, -6L
), class = "data.frame"), structure(list(ppnet = structure(1:2, .Label = c("No",
"Yes"), class = "factor"), Freq = c(75018581.6728, 154405558.0351
)), .Names = c("ppnet", "Freq"), row.names = c(NA, -2L), class = "data.frame")),
list(structure(list(agegend = structure(1:8, .Label = c("F18",
"F30", "F45", "F60", "M18", "M30", "M45", "M60"), class = "factor"),
Freq = c(25400384.1463, 30751632.9884, 33012228.3367,
34040245.6434, 25502247.0411, 29627334.9979, 31203698.6037,
28291988.3917)), .Names = c("agegend", "Freq"), row.names = c(NA,
-8L), class = "data.frame"), structure(list(ethm = structure(c(5L,
2L, 4L, 3L, 1L), .Label = c("2+ Races, Non-Hispanic", "Black, Non-Hispanic",
"Hispanic", "Other, Non-Hispanic", "White, Non-Hispanic"), class = "factor"),
Freq = c(155998326.6087, 27576681.5034, 15276973.8488,
35988933.7952, 2988844.3931)), .Names = c("ethm", "Freq"
), row.names = c(NA, -5L), class = "data.frame"), structure(list(
educat = structure(c(3L, 2L, 4L, 1L), .Label = c("Bachelor's Degree or More",
"High School", "Less than High School", "Some College"
), class = "factor"), Freq = c(29270484.983, 71576288.7676,
67722029.6671, 69260956.7314)), .Names = c("educat",
"Freq"), row.names = c(NA, -4L), class = "data.frame"), structure(list(
regmetro = structure(1:8, .Label = c("MWM", "MWNM", "NEM",
"NENM", "SM", "SNM", "WM", "WNM"), class = "factor"),
Freq = c(0, 0, 38787888.6548, 4372395.3924, 72311195.5418,
15444208.8927, 50195392.9059, 4226183.4607)), .Names = c("regmetro",
"Freq"), row.names = c(NA, -8L), class = "data.frame"), structure(list(
incomcat = structure(c(1L, 2L, 4L, 5L, 6L, 3L), .Label = c("-10",
"10-29", "100+", "30-49", "50-79", "80-99"), class = "factor"),
Freq = c(12213042.96, 42956883.03, 42267711.04, 50947853.13,
24305596.96, 64237947.82)), .Names = c("incomcat", "Freq"
), row.names = c(NA, -6L), class = "data.frame"), structure(list(
ppnet = structure(1:2, .Label = c("No", "Yes"), class = "factor"),
Freq = c(75018581.6728, 154405558.0351)), .Names = c("ppnet",
"Freq"), row.names = c(NA, -2L), class = "data.frame")))
pop.marg<-pop.margins
pop.margins[[1]]
population.margins<-list(
data.frame(agegend=pop.marg[[1]][[1]][,1], Freq=(pop.marg[[1]][[1]][,2]/sum(pop.marg[[1]][[1]][,2]))*nrow(newdata_complete)),
data.frame(ethm=pop.marg[[1]][[2]][,1], Freq=(pop.marg[[1]][[2]][,2]/sum(pop.marg[[1]][[2]][,2]))*nrow(newdata_complete)),
data.frame(educat=pop.marg[[1]][[3]][,1], Freq=(pop.marg[[1]][[3]][,2]/sum(pop.marg[[1]][[3]][,2]))*nrow(newdata_complete)),
data.frame(regmetro=pop.marg[[1]][[4]][,1], Freq=(pop.marg[[1]][[4]][,2]/sum(pop.marg[[1]][[4]][,2]))*nrow(newdata_complete)),
data.frame(incomcat=pop.marg[[1]][[5]][,1], Freq=(pop.marg[[1]][[5]][,2]/sum(pop.marg[[1]][[5]][,2]))*nrow(newdata_complete)),
data.frame(ppnet=pop.marg[[1]][[6]][,1], Freq=(pop.marg[[1]][[6]][,2]/sum(pop.marg[[1]][[6]][,2]))*nrow(newdata_complete))
)
population.margins[[1]]
population.margins[[2]]
population.margins[[3]]
population.margins[[4]]
population.margins[[5]]
population.margins[[6]]
mydesign <-svydesign(ids = ~1, strata=~strata2, data = newdata_complete, weights=rep(1,nrow(newdata_complete)))
weightDesign1<-rake(design = mydesign,
sample.margins = list(~agegend, ~ethm, ~educat, ~regmetro, ~incomcat),
population.margins = population.margins[1:5])
weightDesign1[[5]]
summary(weights(weightDesign1))
max(weights(weightDesign1))
?trimWeights
rm(list=ls())
pop.margins <-
list(list(structure(list(agegend = structure(1:8, .Label = c("F18",
"F30", "F45", "F60", "M18", "M30", "M45", "M60"), class = "factor"),
Freq = c(25015824.2179, 30309875.9965, 32573327.9027, 31644763.1043,
25763098.0698, 29575256.9933, 30957724.9853, 26177261.0073
)), .Names = c("agegend", "Freq"), row.names = c(NA, -8L), class = "data.frame"),
structure(list(ethm = structure(c(5L, 2L, 4L, 3L, 1L), .Label = c("2+ Races, Non-Hispanic",
"Black, Non-Hispanic", "Hispanic", "Other, Non-Hispanic",
"White, Non-Hispanic"), class = "factor"), Freq = c(156450435.931,
26805108.3256, 12922130.6191, 33201634.7689, 2637822.6325
)), .Names = c("ethm", "Freq"), row.names = c(NA, -5L), class = "data.frame"),
structure(list(educat = structure(c(3L, 2L, 4L, 1L), .Label = c("Bachelor's Degree or More",
"High School", "Less than High School", "Some College"), class = "factor"),
Freq = c(30067821.4337, 70334087.0449, 66585593.7032,
65029630.0953)), .Names = c("educat", "Freq"), row.names = c(NA,
-4L), class = "data.frame"), structure(list(regmetro = structure(1:8, .Label = c("MWM",
"MWNM", "NEM", "NENM", "SM", "SNM", "WM", "WNM"), class = "factor"),
Freq = c(38779079.986, 11580740.4967, 38140143.6799,
4506384.8787, 69468312.5372, 15238273.1548, 48594531.843,
4142589.8707)), .Names = c("regmetro", "Freq"), row.names = c(NA,
-8L), class = "data.frame"), structure(list(incomcat = structure(c(1L,
2L, 4L, 5L, 6L, 3L), .Label = c("-10", "10-29", "100+", "30-49",
"50-79", "80-99"), class = "factor"), Freq = c(12591172.74,
43653282.56, 42016636.15, 50511057.84, 23758243.15, 58663387.09
)), .Names = c("incomcat", "Freq"), row.names = c(NA, -6L
), class = "data.frame"), structure(list(ppnet = structure(1:2, .Label = c("No",
"Yes"), class = "factor"), Freq = c(75018581.6728, 154405558.0351
)), .Names = c("ppnet", "Freq"), row.names = c(NA, -2L), class = "data.frame")),
list(structure(list(agegend = structure(1:8, .Label = c("F18",
"F30", "F45", "F60", "M18", "M30", "M45", "M60"), class = "factor"),
Freq = c(25400384.1463, 30751632.9884, 33012228.3367,
34040245.6434, 25502247.0411, 29627334.9979, 31203698.6037,
28291988.3917)), .Names = c("agegend", "Freq"), row.names = c(NA,
-8L), class = "data.frame"), structure(list(ethm = structure(c(5L,
2L, 4L, 3L, 1L), .Label = c("2+ Races, Non-Hispanic", "Black, Non-Hispanic",
"Hispanic", "Other, Non-Hispanic", "White, Non-Hispanic"), class = "factor"),
Freq = c(155998326.6087, 27576681.5034, 15276973.8488,
35988933.7952, 2988844.3931)), .Names = c("ethm", "Freq"
), row.names = c(NA, -5L), class = "data.frame"), structure(list(
educat = structure(c(3L, 2L, 4L, 1L), .Label = c("Bachelor's Degree or More",
"High School", "Less than High School", "Some College"
), class = "factor"), Freq = c(29270484.983, 71576288.7676,
67722029.6671, 69260956.7314)), .Names = c("educat",
"Freq"), row.names = c(NA, -4L), class = "data.frame"), structure(list(
regmetro = structure(1:8, .Label = c("MWM", "MWNM", "NEM",
"NENM", "SM", "SNM", "WM", "WNM"), class = "factor"),
Freq = c(0, 0, 38787888.6548, 4372395.3924, 72311195.5418,
15444208.8927, 50195392.9059, 4226183.4607)), .Names = c("regmetro",
"Freq"), row.names = c(NA, -8L), class = "data.frame"), structure(list(
incomcat = structure(c(1L, 2L, 4L, 5L, 6L, 3L), .Label = c("-10",
"10-29", "100+", "30-49", "50-79", "80-99"), class = "factor"),
Freq = c(12213042.96, 42956883.03, 42267711.04, 50947853.13,
24305596.96, 64237947.82)), .Names = c("incomcat", "Freq"
), row.names = c(NA, -6L), class = "data.frame"), structure(list(
ppnet = structure(1:2, .Label = c("No", "Yes"), class = "factor"),
Freq = c(75018581.6728, 154405558.0351)), .Names = c("ppnet",
"Freq"), row.names = c(NA, -2L), class = "data.frame")))
pop.margins <-
list(list(structure(list(agegend = structure(1:8, .Label = c("F18",
"F30", "F45", "F60", "M18", "M30", "M45", "M60"), class = "factor"),
Freq = c(25015824.2179, 30309875.9965, 32573327.9027, 31644763.1043,
25763098.0698, 29575256.9933, 30957724.9853, 26177261.0073
)), .Names = c("agegend", "Freq"), row.names = c(NA, -8L), class = "data.frame"),
structure(list(ethm = structure(c(5L, 2L, 4L, 3L, 1L), .Label = c("2+ Races, Non-Hispanic",
"Black, Non-Hispanic", "Hispanic", "Other, Non-Hispanic",
"White, Non-Hispanic"), class = "factor"), Freq = c(156450435.931,
26805108.3256, 12922130.6191, 33201634.7689, 2637822.6325
)), .Names = c("ethm", "Freq"), row.names = c(NA, -5L), class = "data.frame"),
structure(list(educat = structure(c(3L, 2L, 4L, 1L), .Label = c("Bachelor's Degree or More",
"High School", "Less than High School", "Some College"), class = "factor"),
Freq = c(30067821.4337, 70334087.0449, 66585593.7032,
65029630.0953)), .Names = c("educat", "Freq"), row.names = c(NA,
-4L), class = "data.frame"), structure(list(regmetro = structure(1:8, .Label = c("MWM",
"MWNM", "NEM", "NENM", "SM", "SNM", "WM", "WNM"), class = "factor"),
Freq = c(38779079.986, 11580740.4967, 38140143.6799,
4506384.8787, 69468312.5372, 15238273.1548, 48594531.843,
4142589.8707)), .Names = c("regmetro", "Freq"), row.names = c(NA,
-8L), class = "data.frame"), structure(list(incomcat = structure(c(1L,
2L, 4L, 5L, 6L, 3L), .Label = c("-10", "10-29", "100+", "30-49",
"50-79", "80-99"), class = "factor"), Freq = c(12591172.74,
43653282.56, 42016636.15, 50511057.84, 23758243.15, 58663387.09
)), .Names = c("incomcat", "Freq"), row.names = c(NA, -6L
), class = "data.frame"), structure(list(ppnet = structure(1:2, .Label = c("No",
"Yes"), class = "factor"), Freq = c(75018581.6728, 154405558.0351
)), .Names = c("ppnet", "Freq"), row.names = c(NA, -2L), class = "data.frame")),
list(structure(list(agegend = structure(1:8, .Label = c("F18",
"F30", "F45", "F60", "M18", "M30", "M45", "M60"), class = "factor"),
Freq = c(25328621.1159, 30617515.0108, 33052091.2564,
33087971.7401, 25225172.0706, 29481309.0026, 31238688.3169,
27370887.6896)), .Names = c("agegend", "Freq"), row.names = c(NA,
-8L), class = "data.frame"), structure(list(ethm = structure(c(5L,
2L, 4L, 3L, 1L), .Label = c("2+ Races, Non-Hispanic", "Black, Non-Hispanic",
"Hispanic", "Other, Non-Hispanic", "White, Non-Hispanic"), class = "factor"),
Freq = c(155686983.4866, 27069363.8708, 14310702.8886,
35302843.296, 3032362.6609)), .Names = c("ethm", "Freq"
), row.names = c(NA, -5L), class = "data.frame"), structure(list(
educat = structure(c(3L, 2L, 4L, 1L), .Label = c("Bachelor's Degree or More",
"High School", "Less than High School", "Some College"
), class = "factor"), Freq = c(29567052.6851, 70784805.3979,
67705180.5307, 67345217.5892)), .Names = c("educat",
"Freq"), row.names = c(NA, -4L), class = "data.frame"), structure(list(
regmetro = structure(1:8, .Label = c("MWM", "MWNM", "NEM",
"NENM", "SM", "SNM", "WM", "WNM"), class = "factor"),
Freq = c(39303996.1378, 11379865.9202, 38366947.5265,
4498513.2758, 71121242.2641, 15502097.8221, 49246938.9303,
4310620.7711)), .Names = c("regmetro", "Freq"), row.names = c(NA,
-8L), class = "data.frame"), structure(list(incomcat = structure(c(1L,
2L, 4L, 5L, 6L, 3L), .Label = c("-10", "10-29", "100+", "30-49",
"50-79", "80-99"), class = "factor"), Freq = c(17599494.95,
55450098.72, 57127947.89, 66792527.12, 30803643.89, 80117805.93
)), .Names = c("incomcat", "Freq"), row.names = c(NA, -6L
), class = "data.frame"), structure(list(ppnet = structure(1:2, .Label = c("No",
"Yes"), class = "factor"), Freq = c(67070215, 164206388)), .Names = c("ppnet",
"Freq"), row.names = c(NA, -2L), class = "data.frame")),
list(structure(list(agegend = structure(1:8, .Label = c("F18",
"F30", "F45", "F60", "M18", "M30", "M45", "M60"), class = "factor"),
Freq = c(25400384.1463, 30751632.9884, 33012228.3367,
34040245.6434, 25502247.0411, 29627334.9979, 31203698.6037,
28291988.3917)), .Names = c("agegend", "Freq"), row.names = c(NA,
-8L), class = "data.frame"), structure(list(ethm = structure(c(5L,
2L, 4L, 3L, 1L), .Label = c("2+ Races, Non-Hispanic", "Black, Non-Hispanic",
"Hispanic", "Other, Non-Hispanic", "White, Non-Hispanic"), class = "factor"),
Freq = c(155998326.6087, 27576681.5034, 15276973.8488,
35988933.7952, 2988844.3931)), .Names = c("ethm", "Freq"
), row.names = c(NA, -5L), class = "data.frame"), structure(list(
educat = structure(c(3L, 2L, 4L, 1L), .Label = c("Bachelor's Degree or More",
"High School", "Less than High School", "Some College"
), class = "factor"), Freq = c(29270484.983, 71576288.7676,
67722029.6671, 69260956.7314)), .Names = c("educat",
"Freq"), row.names = c(NA, -4L), class = "data.frame"), structure(list(
regmetro = structure(1:8, .Label = c("MWM", "MWNM", "NEM",
"NENM", "SM", "SNM", "WM", "WNM"), class = "factor"),
Freq = c(39403224.9456, 11398158.9006, 38787888.6548,
4372395.3924, 72311195.5418, 15444208.8927, 50195392.9059,
4226183.4607)), .Names = c("regmetro", "Freq"), row.names = c(NA,
-8L), class = "data.frame"), structure(list(incomcat = structure(c(1L,
2L, 4L, 5L, 6L, 3L), .Label = c("-10", "10-29", "100+", "30-49",
"50-79", "80-99"), class = "factor"), Freq = c(12213042.96,
42956883.03, 42267711.04, 50947853.13, 24305596.96, 64237947.82
)), .Names = c("incomcat", "Freq"), row.names = c(NA, -6L
), class = "data.frame"), structure(list(ppnet = structure(1:2, .Label = c("No",
"Yes"), class = "factor"), Freq = c(67070215, 164206388)), .Names = c("ppnet",
"Freq"), row.names = c(NA, -2L), class = "data.frame")))
pop.margins[[1]]
x<-pop.margins[[1]][[1]]
x
props.col<-x[,2]/sum(x[,2])
props.col
sum(props.col)
x[,2]<-props.col
x
simple.prop<-function(x){
props.col<-x[,2]/sum(x[,2])
x[,2]<-props.col
return(x)
}
x<-pop.margins[[1]]
new.list<-apply(x,3, simple.prop)
dim(x)
library(plyr)
detach(faraway)
new.list<-llply(x, simple.prop)
new.list
props<-function(x){
new.list<-llply(x, simple.prop)
}
props<-function(x){
new.list<-llply(x, simple.prop)
return(new.list)
}
pop.margins
new.pop.margins<-llply(pop.margins, props)
new.pop.margins
?dump
pop.margins
new.pop.margins
dump(new.pop.margins, file="/Users/michelletorres/Dropbox/SEMESTER2/R-Programming/TAPSPackage/TAPSweights/Extra_Scripts/newList.R")
dump("new.pop.margins", file="/Users/michelletorres/Dropbox/SEMESTER2/R-Programming/TAPSPackage/TAPSweights/Extra_Scripts/newList.R")
